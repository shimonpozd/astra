# ТЗ для Frontend: Интерактивный стол (Drag-and-Drop)

## 1. Концепция

Мы превращаем интерфейс в "интерактивный стол для изучения". Правая панель становится "книжной полкой" с доступными текстами, а основная область чата — "рабочим столом", куда пользователь может перетаскивать источники для обсуждения.

Это позволит пользователю самому управлять ходом изучения, а агенту — ассистировать в этом процессе.

## 2. Механика Drag-and-Drop

Ключевое нововведение — возможность перетаскивать элементы из правой панели в область чата.

1.  **Источник перетаскивания (Drag Source):** Элементы в списке комментаторов (событие `commentators_list`) должны быть сделаны перетаскиваемыми.

2.  **Цель (Drop Target):** Область чата (или, что еще лучше, непосредственно поле для ввода текста) должна стать целью для перетаскивания.

3.  **Действие (The Action):** Когда пользователь "бросает" элемент комментатора в область чата, фронтенд должен немедленно отправить на бэкенд стандартный запрос `/chat/stream`.

## 3. Запрос на Бэкенд при Drop

- **Содержимое запроса:** `text` в теле запроса должен содержать стандартизированную команду, которую поймет агент. Предлагаю использовать следующий формат:
  `Изучаем комментарий: [ref]`

- **Пример:** Пользователь перетаскивает элемент "Rashi on Shabbat 25a:1:1". Фронтенд должен взять `sourceRef` или `anchorRef` из этого элемента и отправить запрос с текстом:
  `Изучаем комментарий: Rashi on Shabbat 25a:1:1`

  Этот запрос может быть отправлен "под капотом", пользователю его видеть не обязательно.

## 4. Ожидаемое поведение системы

После того как фронтенд отправит этот запрос, бэкенд и агент сделают следующее:

1.  Агент `chevruta_study_bimodal` получит команду.
2.  Его системный промпт направит его на использование инструмента `sefaria_get_text_v3` с указанным `ref`.
3.  Бэкенд получит результат и:
    а. Отправит на фронтенд событие `source` с текстом этого комментария (он появится в правой панели).
    б. Сохранит этот текст в сессионную память Qdrant.
4.  Агент в чате ответит что-то вроде: "Хорошо, вот текст Раши..."

## 5. Итоговый сценарий пользователя (User Flow)

1.  Пользователь просит: "Открой Шаббат 25а.1".
    *   Текст появляется в правой панели (событие `source`).
2.  Пользователь просит: "Какие есть комментаторы?"
    *   Список комментаторов появляется в правой панели (событие `commentators_list`).
3.  Пользователь **перетаскивает** "Раши" из списка в чат.
    *   Текст Раши появляется в правой панели (новое событие `source`).
    *   Агент в чате говорит: "Вот текст Раши..."
4.  Пользователь спрашивает: "Объясни, что он имеет в виду?"
    *   Агент использует инструмент `recall_research_sources`, находит в памяти сессии и текст Шаббат 25а.1, и текст Раши, и на основе их обоих отвечает на вопрос.
