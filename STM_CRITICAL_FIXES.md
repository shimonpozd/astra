# STM Critical Fixes - Memory Service

## üö® –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (must-fix)

### ‚úÖ 1) –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ refs –¥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** `UnboundLocalError` - `refs` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –¥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ `update_stm()`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ (–æ—à–∏–±–∫–∞):
summary_refs = summary_result.get("refs", [])
if summary_refs:
    refs = self._merge_refs(refs, summary_refs)  # refs –µ—â—ë –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω

# –°—Ç–∞–ª–æ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
refs = self._extract_refs(last_messages)  # 1) –±–∞–∑–æ–≤—ã–µ refs
if self.summary_service:
    summary_refs = summary_result.get("refs", [])
    if summary_refs:
        refs = self._merge_refs(refs, summary_refs)  # 2) —Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ
```

### ‚úÖ 2) Decay –∑–∞—è–≤–ª–µ–Ω –∫–∞–∫ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π, –Ω–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ª–∏–Ω–µ–π–Ω—ã–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–∏–Ω–µ–π–Ω—ã–π decay `1 - rate*age` –≤–º–µ—Å—Ç–æ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ (–ª–∏–Ω–µ–π–Ω—ã–π):
decay_factor = 1.0 - (decay_rate * age_hours)
decayed_score = item.get("score", 0) * max(0, decay_factor)

# –°—Ç–∞–ª–æ (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π):
decay_rate = math.log(2) / max(half_life_hours, 0.01)  # True exponential
decayed_score = item.get("score", 0) * math.exp(-decay_rate * age_hours)
```

### ‚úÖ 3) –ù–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã —Å–ª–æ—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** `MAX_GLOSSARY` –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –≤–º–µ—Å—Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ __init__:
self.max_glossary = slots_config.get("glossary_max_items", self.MAX_GLOSSARY)

# –ó–∞–º–µ–Ω–µ–Ω–æ –≤ –∫–æ–¥–µ:
"glossary": merged_glossary[:self.max_glossary],  # –≤–º–µ—Å—Ç–æ MAX_GLOSSARY
```

### ‚úÖ 4) –î–≤–æ–π–Ω–æ–π —Ä–∞—Å—á—ë—Ç summary
**–ü—Ä–æ–±–ª–µ–º–∞:** `summary_v1` –∏ `summary_v2` —Å—á–∏—Ç–∞–ª–∏—Å—å –æ—Ç–¥–µ–ª—å–Ω–æ –∏–∑ –æ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ:
summary_v1 = self._generate_running_summary(last_messages)  # –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

# –°—Ç–∞–ª–æ:
summary_v1 = summary_v2 or self._generate_running_summary(last_messages)  # –∏–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
```

## üîß –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### ‚úÖ 5) –ë—é–¥–∂–µ—Ç –∏–Ω—ä–µ–∫—Ü–∏–∏ –≤ –ø—Ä–æ–º–ø—Ç (safety-cap)
**–ü—Ä–æ–±–ª–µ–º–∞:** `format_stm_for_prompt` –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–ª –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
def format_stm_for_prompt(self, stm, ..., max_chars_budget: int = 1200) -> str:
    budget = 0
    
    def add_line(s: str) -> bool:
        nonlocal budget
        if budget + len(s) + 1 > max_chars_budget:
            return False
        parts.append(s)
        budget += len(s) + 1
        return True
    
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: bullets ‚Üí facts ‚Üí loops ‚Üí refs
    # –ö–∞–∂–¥—ã–π –±–ª–æ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –±—é–¥–∂–µ—Ç
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω UnboundLocalError** - refs —Ç–µ–ø–µ—Ä—å –æ–±—ä—è–≤–ª—è–µ—Ç—Å—è –¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π decay** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –¥–ª—è —Å—Ç–∞—Ä–µ–Ω–∏—è
- ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã** - –≤—Å–µ —Å–ª–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

### –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å  
- ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** - summary_v1 –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ –µ—Å—Ç—å summary_v2
- ‚úÖ **–ë—é–¥–∂–µ—Ç –∏–Ω—ä–µ–∫—Ü–∏–∏** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–∞–∑–¥—É–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
- ‚úÖ **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ** - bullets ‚Üí facts ‚Üí loops ‚Üí refs

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ **–ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å** - –≤—Å–µ –ª–∏–º–∏—Ç—ã —Å–ª–æ—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ª–∏–º–∏—Ç—ã** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤
- ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –±—é–¥–∂–µ—Ç –∏–Ω—ä–µ–∫—Ü–∏–∏

## üéØ –°—Ç–∞—Ç—É—Å

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!** STM —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ:

- ‚úÖ –ù–µ—Ç runtime –æ—à–∏–±–æ–∫
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π decay  
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤

STM –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É! üöÄ




