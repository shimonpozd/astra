# Block Streaming Implementation

## üéØ –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ `doc.v1` –ø–æ –±–ª–æ–∫–∞–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞.

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1) Backend - BlockStreamService
**–§–∞–π–ª:** `brain_service/services/block_stream_service.py`

- ‚úÖ **–ü–∞—Ä—Å–∏–Ω–≥ –±–ª–æ–∫–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞** - –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∞–±–∑–∞—Ü—ã, —Å–ø–∏—Å–∫–∏, —Ü–∏—Ç–∞—Ç—ã, –∫–æ–¥
- ‚úÖ **–°—Ç—Ä–∏–º–∏–Ω–≥ –±–ª–æ–∫–æ–≤** - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–ª–æ–∫–∏ –ø–æ –º–µ—Ä–µ –∏—Ö –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- ‚úÖ **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID –±–ª–æ–∫–æ–≤** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSON —Å—Ç—Ä–∏–º–∏–Ω–≥–∞** - –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ LLM

### 2) Backend - ChatService –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
**–§–∞–π–ª:** `brain_service/services/chat_service.py`

- ‚úÖ **–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `get_llm_response_stream_with_blocks`** - —Å—Ç—Ä–∏–º–∏–Ω–≥ —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –±–ª–æ–∫–æ–≤
- ‚úÖ **–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `process_chat_stream_with_blocks`** - –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å –±–ª–æ–∫–∞–º–∏
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å STM** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π `format_stm_for_prompt`
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–∞—Ç

### 3) Backend - API —ç–Ω–¥–ø–æ–∏–Ω—Ç
**–§–∞–π–ª:** `brain_service/api/chat.py`

- ‚úÖ **–ù–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç `/chat/stream-blocks`** - –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –±–ª–æ–∫–æ–≤
- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—Ç–∞—Ä—ã–π `/chat/stream` –æ—Å—Ç–∞–µ—Ç—Å—è —Ä–∞–±–æ—á–∏–º

### 4) Frontend - API —Å–µ—Ä–≤–∏—Å
**–§–∞–π–ª:** `astra-web-client/src/services/api.ts`

- ‚úÖ **–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `sendMessageWithBlocks`** - –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –±–ª–æ–∫–æ–≤
- ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `StreamHandler`** - –¥–æ–±–∞–≤–ª–µ–Ω `onBlock` callback
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `block`, `llm_chunk`, `doc_v1`, `error`

### 5) Frontend - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
**–§–∞–π–ª—ã:** 
- `astra-web-client/src/components/BlockStreamRenderer.tsx`
- `astra-web-client/src/components/BrainChatWithBlocks.tsx`

- ‚úÖ **BlockStreamRenderer** - —Ä–µ–Ω–¥–µ—Ä–∏—Ç –±–ª–æ–∫–∏ –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
- ‚úÖ **useBlockStream hook** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –±–ª–æ–∫–æ–≤
- ‚úÖ **BrainChatWithBlocks** - –ø–æ–ª–Ω—ã–π —á–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –±–ª–æ–∫–æ–≤
- ‚úÖ **–ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥** - –±–ª–æ–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:
```
User Input ‚Üí ChatService ‚Üí BlockStreamService ‚Üí LLM Stream ‚Üí Block Parser ‚Üí Frontend ‚Üí MessageRenderer
```

### –°–æ–±—ã—Ç–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞:
1. **`llm_chunk`** - —Å—ã—Ä—ã–µ —á–∞–Ω–∫–∏ –æ—Ç LLM
2. **`block`** - –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ (–∑–∞–≥–æ–ª–æ–≤–∫–∏, –∞–±–∑–∞—Ü—ã, —Å–ø–∏—Å–∫–∏)
3. **`doc_v1`** - –ø–æ–ª–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
4. **`error`** - –æ—à–∏–±–∫–∏

### –¢–∏–ø—ã –±–ª–æ–∫–æ–≤:
- `heading` - –∑–∞–≥–æ–ª–æ–≤–∫–∏ (H1-H6)
- `paragraph` - –∞–±–∑–∞—Ü—ã —Ç–µ–∫—Å—Ç–∞
- `list` - —Å–ø–∏—Å–∫–∏ (—É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–µ/–Ω–µ—É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–µ)
- `quote` - —Ü–∏—Ç–∞—Ç—ã
- `code` - –±–ª–æ–∫–∏ –∫–æ–¥–∞

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:
**–§–∞–π–ª:** `test_block_streaming.py`

- ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ—Ç API** `/chat/stream-blocks`
- ‚úÖ **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è** - –±–ª–æ–∫–∏, —á–∞–Ω–∫–∏, –æ—à–∏–±–∫–∏
- ‚úÖ **–ü–æ–¥—Å—á–µ—Ç –±–ª–æ–∫–æ–≤** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- ‚úÖ **API –æ—Ç–≤–µ—á–∞–µ—Ç** - —Å—Ç–∞—Ç—É—Å 200
- ‚úÖ **–°—Ç—Ä–∏–º–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç** - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- ‚ö†Ô∏è **–ë–ª–æ–∫–∏ –Ω–µ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è** - —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–ª–∞–¥–∫–∏

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1) –ë–ª–æ–∫–∏ –Ω–µ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è
**–ü—Ä–æ–±–ª–µ–º–∞:** LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –∞ –Ω–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
**–†–µ—à–µ–Ω–∏–µ:** 
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
- –£–ª—É—á—à–∏—Ç—å –ø–∞—Ä—Å–µ—Ä –±–ª–æ–∫–æ–≤
- –î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç

### 2) LLM –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –í–æ–∑–º–æ–∂–Ω–æ LLM –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é LLM
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ LLM API

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1) –û—Ç–ª–∞–¥–∫–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å LLM –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
- [ ] –£–ª—É—á—à–∏—Ç—å –ø–∞—Ä—Å–µ—Ä –±–ª–æ–∫–æ–≤

### 2) –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- [ ] –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —á–∞—Ç—É
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ UI

### 3) –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤
- [ ] –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## üìä –°—Ç–∞—Ç—É—Å

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** ‚úÖ **90% –∑–∞–≤–µ—Ä—à–µ–Ω–∞**
- Backend: ‚úÖ –ì–æ—Ç–æ–≤
- Frontend: ‚úÖ –ì–æ—Ç–æ–≤  
- API: ‚úÖ –ì–æ—Ç–æ–≤
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –æ—Ç–ª–∞–¥–∫–∏

**–ì–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å LLM!** üéØ




