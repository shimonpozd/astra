# Спецификация событий для Frontend (Deep Research Flow)

## 1. Обзор

Этот документ описывает, как фронтенд-клиент должен обрабатывать поток данных, получаемый от бэкенда (`/chat/stream`) при выполнении запроса на глубокое исследование (`deepresearch`).

Бэкенд отправляет поток в формате **ndjson** (newline-delimited JSON). Это означает, что каждый объект JSON отправляется отдельной строкой. Клиент должен читать этот поток построчно, парсить каждую строку как JSON и обновлять интерфейс в реальном времени в зависимости от типа события.

## 2. Логика работы Frontend

1.  **Инициация запроса**: Пользователь отправляет запрос, который начинается с `/research`.
2.  **Чтение потока**: Клиент начинает слушать события из `StreamingResponse`.
3.  **Обработка событий**: В цикле клиент читает поток, пока он не закроется.
    *   Прочитать очередную строку.
    *   Если строка пустая, проигнорировать.
    *   Распарсить строку как JSON-объект.
    *   Использовать `switch` по полю `type` в полученном объекте, чтобы определить, как обновить UI.
    *   Когда приходит событие `final_draft`, это сигнал о завершении исследования. Нужно отобразить финальный ответ и можно прекращать обработку.

## 3. Типы событий

Ниже описаны основные типы событий, которые клиент должен обрабатывать.

### `status`
Сообщение о текущем шаге процесса.
- **Структура**: `{"type": "status", "data": {"message": "Сообщение о статусе..."}}`
- **Применение**: Отображать в специальной панели "мыслей" или логов, чтобы пользователь видел, что система работает.
- **Пример**: `{"type": "status", "data": {"message": "[1] Fetching and processing sources..."}}`

### `plan`
Начальный план исследования, сгенерированный агентом.
- **Структура**: `{"type": "plan", "data": {"primary_ref": "...", "research_questions": [...], ...}}`
- **Применение**: Отобразить в панели "мыслей" агента, чтобы показать его намерения.

### `source`
Событие, связанное с обработкой одного из источников.
- **Структура**: `{"type": "source", "data": {"ref": "...", "status": "...", "summary": "..."}}`
- **Применение**: Показывать в логе работы, чтобы пользователь видел, какие источники анализируются.

### `draft` (Только в режиме отладки)
Промежуточный черновик ответа.
- **Структура**: `{"type": "draft", "data": {"iteration": N, "draft": "Текст черновика..."}}`
- **Применение**: **НЕ показывать конечному пользователю.** Это событие предназначено для отладки. Фронтенд может отображать его в специальной, скрытой по умолчанию панели, если в UI включен режим отладки.

### `critique`
Внутренняя критика агентом своего же черновика.
- **Структура**: `{"type": "critique", "data": {"iteration": N, "feedback": [...]}}`
- **Применение**: Отобразить в панели "мыслей" агента. Показывает, как агент пытается улучшить свой ответ.

### `final_draft` (Финальный результат)
Главное событие, содержащее финальный, полный ответ.
- **Структура**: `{"type": "final_draft", "data": {"draft": "Финальный текст ответа...", "model": "...", "total_iterations": N, ...}}`
- **Применение**: **Это финальный ответ.** Когда приходит это событие, клиент должен:
    1.  Взять содержимое поля `data.draft`.
    2.  Отобразить его в основном окне для ответа пользователю.
    3.  После этого события поток можно считать завершенным и закрывать соединение.

---

## 4. Важное замечание для Backend (и для информации Frontend)

Текущая реализация бэкенда после отправки JSON-объекта `final_draft` дополнительно отправляет "сырой" (raw) текст этого же ответа.
```python
# main.py
# ...
yield json.dumps({"type": "final_draft", "data": ...})

# Затем сразу же:
yield final_draft_result.get("draft", "") # <-- Эта строка нарушает формат ndjson
```
Отправка "сырого" текста нарушает протокол `ndjson`, так как клиент ожидает получить JSON в каждой строке. Это может привести к ошибке парсинга на клиенте.

**Рекомендация**: Убрать отправку "сырого" текста, так как вся необходимая информация уже содержится в событии `final_draft`. Фронтенд должен полагаться **только** на `{"type": "final_draft"}` для получения финального ответа.
