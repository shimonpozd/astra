ТЗ для фронтенда: «Интерактивный Учебный Стол»

Документ — список задач для React-клиента. Цель: добавить режим «Учебного стола» поверх существующего чат-интерфейса.

0) Базовые требования

Технологии: React 18+, TypeScript, React Query (или RTK Query), React Router, стили на твой выбор (Tailwind/Chakra/MUI).

Архитектура: модульная, все сетевые вызовы — через слой api/*.

i18n: русская локаль (английская — вторично).

Адаптив: десктоп приоритет, планшет — упрощённый, мобайл — допустимо только чтение.

1) Страницы и маршруты

/ — существующий чат.

/study/:sessionId — Учебный стол (новый экран).

/study/:sessionId/graph — (опционально) граф-просмотр.

Задачи:

 Добавить маршруты и ленивую загрузку страниц (code splitting).

2) Экран «Учебный стол» — состав

Макет из 4 зон:

Хлебные крошки (верхняя панель)

Окно фокуса (центр) + окно контекста (±5 соседей, притушено)

Книжная полка (правая панель с карточками)

Локальный чат для фокуса (нижняя/левая панель, вкладка)

Задачи:

 Скелет лэйаута с ресайз-панелями (split panes).

 Темы: светлая/тёмная (CSS vars).

3) API-клиенты (слой api/)

Методы (см. серверное ТЗ):

 POST /study/resolve — распознать ввод в tref → нормализованный ref или список кандидатов.

 POST /study/set_focus — установить фокус, вернуть snapshot.

 POST /study/back / POST /study/forward — перемещение по истории.

 POST /study/restore — перейти к снимку по индексу.

 GET /study/state?session_id=... — получить current snapshot.

 POST /study/chat — локальный чат по текущему фокусу.

 GET /study/bookshelf/item?session_id=...&ref=... — полный текст карточки.

 (опц.) GET /study/graph?session_id=... — данные для графа.

 (опц.) POST /study/deepresearch — запустить deep research для фокуса.

Интерфейсы типов (в types/study.ts):

 StudySnapshot (focus, window.prev/next[], bookshelf.counts/items[], chat_local[])

 BookshelfItem, NeighborItem, ChatEntry

Интеграция:

 Обработчики ошибок + toasts.

 Кеширование current snapshot (React Query, ключ ["study","state",sessionId]).

 Ретрай только на idempotent-GET.

4) Хедер: «Хлебные крошки»

Функционал:

Путь из истории снимков (название/короткий ref).

Клик по крошке → POST /study/restore (без обрезки истории).

Кнопки Back/Forward → POST /study/back/forward.

Кнопка «Deep Research» → POST /study/deepresearch (результат открываем в модалке/новой вкладке).

Задачи:

 Компонент StudyBreadcrumbs.

 Кнопки Back/Forward с disabled-состоянием.

 UX: длинные названия — усечение, tooltip.

5) Окно фокуса + окно контекста

Фокус:

Белая тема, полноценный текст (text_full), title.

Кнопки «следующий/предыдущий» (двигают через set_focus на соседний ref).

Контекст (±5):

Сверху — 5 «prev», снизу — 5 «next».

Каждый сосед — карточка-строка (≤600 симв.), притушенный текст.

Клик на соседа → set_focus на его ref.

Задачи:

 Компонент FocusViewer: рендер текста + копирование ref.

 Компонент NeighborsStrip: список соседей, hover-подсветка.

 Плавная прокрутка к фокусу; sticky заголовок.

UX-детали:

 Skeleton-состояния при загрузке.

 Ограничение ширины текста (читабельная колонка).

 Горячие клавиши: ←/→ (prev/next), Alt+←/→ (Back/Forward).

6) Книжная полка (Bookshelf)

Панель справа: вкладки категорий (по counts), список карточек одного размера.

Функционал:

Список карточек: title, commentator, category, preview, ref.

Вкладки-фильтры (по категориям) — переключают запрос/срез.

Кнопки пагинации (если сервер отдаёт limit/offset).

Карточка:

Кнопка «Открыть как фокус» → set_focus(ref).

Кнопка «Показать полностью» → GET /bookshelf/item (модалка).

Кнопка «В чат» — шлёт в общий чат (как сейчас) текст/ссылку.

Задачи:

 Компоненты BookshelfPanel, BookshelfTabs, BookshelfCard.

 Состояния загрузки/ошибок.

 Виртуализация списка (если >200 карточек).

7) Локальный чат по фокусу

Отдельная вкладка на странице (или панель снизу):

История из snapshot.chat_local.

Инпут: отправка в POST /study/chat.

Рендер ответа: markdown (поддержка inline-ссылок на ref).

Задачи:

 Компонент FocusChat.

 Автоскролл к последнему сообщению.

 Кнопка «В общий чат» — дублировать последний ответ в текущий глобальный чат (опционально).

8) Панель выбора текста (старт «без LLM»)

Верхняя форма:

Поле ввода (подсказка: «Например, Shabbat 21a.2 или Bereshit 1:1»).

Кнопка «Открыть».

POST /study/resolve → либо нормализованный ref, либо список кандидатов.

Если кандидаты — модалка списка, клик → set_focus.

Задачи:

 Компонент RefResolver.

 Модалка кандидатов с поиском по списку (если много).

9) Граф-просмотр (опционально, v2)

Экран /study/:sessionId/graph:

Вертикальная лента фокусов (из истории).

От каждого — ветви к карточкам из полки (по клику — set_focus).

Лёгкая библиотека графов (D3/Reaflow), без фанатизма.

Задачи:

 Компонент StudyGraph (заглушка с данными из GET /study/graph).

 Навигация назад в «Учебный стол».

10) Состояния/данные (глобально)

 Хранить sessionId в URL/контексте.

 Кэшировать последний StudySnapshot (React Query).

 Синхронизироваться при таб-свитче (Refetch on window focus).

11) Доступность и клавиатура

 Навигация клавишами (см. §5).

 Фокус-кольца и aria-label для карточек и табов.

 Контраст притушенных соседей достаточный (WCAG AA).

12) Производительность

 Скелетоны и optimistic-UI для back/forward/restore.

 Ленивая подгрузка полки (скролл/пагинация).

 Виртуализация длинных списков.

 Ограничение ререндера через мемоизацию.

13) Логирование/ошибки

 Унифицированные toasts для ошибок API.

 Локальные boundary (Fallback UI) на критичных зонах.

 Консольные предупреждения выключить в prod.

14) Интеграция с существующим чатом

 Кнопка «Отправить в общий чат» у карточки полки/фокуса — постит текст/ссылку в текущий чат (как сейчас).

 Из общего чата переход «Открыть в Столе» → роут на /study/:sessionId и set_focus с переданным ref.

15) Флаги и конфиги

 WINDOW_SIZE по умолчанию 5 (UI-настройка на странице).

 Тема: память в localStorage.

 Показывать/скрывать «Graph» (feature flag).

16) Тест-кейсы (DoD)

 Resolve: Shabbat 21a.2 → открывается фокус, соседи ±5, полка заполнена.

 Back/Forward: работает без потери состояния; disabled на границах.

 Restore: клик по крошке — прыжок к снимку, «вперёд» сохранён.

 Neighbors: клики по соседям меняют фокус корректно.

 Bookshelf: вкладки фильтруют; карточка открывается в модалке; «Открыть как фокус» меняет фокус.

 Focus Chat: диалог сохраняется только для текущего фокуса, не ломает глобальный чат.

 Deep Research: кнопка запускает, результат отображается (модалка/таба).

 Перфоманс: скролл полки плавный, ререндеры не «сыпятся».

17) Приоритет внедрения (спринты)

Спринт 1

Маршруты, слой API, типы.

Экран «Учебный стол» каркас.

Set Focus + State + Хлебные крошки + Back/Forward.

Спринт 2

Окно контекста (±5), соседние клики.

Книжная полка: вкладки, карточки, модалка.

Спринт 3

Локальный чат, интеграция с глобальным чатом.

Resolve с кандидатами.

Deep Research кнопка (модалка).

Спринт 4 (опц.)

Граф-просмотр.

Виртуализация, оптимизации, A11y.