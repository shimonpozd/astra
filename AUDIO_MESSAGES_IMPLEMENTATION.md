# üéµ Audio Messages Implementation

–°–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å TTS –∞—É–¥–∏–æ –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Å–ª—É—à–∏–≤–∞—Ç—å, —Å–∫–∞—á–∏–≤–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—É–¥–∏–æ** - TTS –∞—É–¥–∏–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ  
‚úÖ **–ü–µ—Ä–µ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ** - –º–æ–∂–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –∞—É–¥–∏–æ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ  
‚úÖ **–°–∫–∞—á–∏–≤–∞–Ω–∏–µ** - –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã  
‚úÖ **–ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä** - –≤–∏–¥–Ω–æ –ø—Ä–æ–≥—Ä–µ—Å—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è  
‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –ø–∞—É–∑–∞, –ø–µ—Ä–µ–º–æ—Ç–∫–∞, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞  
‚úÖ **–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞** - –∞—É–¥–∏–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏  
‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤** - Yandex, ElevenLabs, XTTS, Orpheus  

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### Frontend (astra-web-client/src/)

**–¢–∏–ø—ã:**
- `types/text.ts` - —Ç–∏–ø—ã `AudioMessage`, `AudioContent`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `components/AudioMessageRenderer.tsx` - –ø–ª–µ–µ—Ä –¥–ª—è –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- `components/ui/AudioTTSButton.tsx` - –∫–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ
- `components/UnifiedMessageRenderer.tsx` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞—É–¥–∏–æ
- `components/chat/ChatViewport.tsx` - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–π

**–°–µ—Ä–≤–∏—Å—ã:**
- `services/ttsService.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- `hooks/useAudioTTS.ts` - —Ö—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ TTS

### Backend (brain_service/)

**API:**
- `api/audio.py` - API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞–º–∏
- `main.py` - –¥–æ–±–∞–≤–ª–µ–Ω —Ä–æ—É—Ç–µ—Ä –¥–ª—è –∞—É–¥–∏–æ API

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏—è

```typescript
import { useAudioTTS } from '../hooks/useAudioTTS';

const { generateAudioMessage, saveAudioMessage } = useAudioTTS({
  voiceId: 'yandex-oksana',
  language: 'ru',
  speed: 1.0,
});

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
const audioMessage = await generateAudioMessage("–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?");

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —á–∞—Ç
await saveAudioMessage(audioMessage, chatId);
```

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∞—É–¥–∏–æ TTS

```tsx
import { AudioTTSButton } from '../components/ui/AudioTTSButton';

<AudioTTSButton
  text="–¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏"
  chatId="chat-123"
  voiceId="yandex-oksana"
  language="ru"
  onAudioGenerated={(message) => console.log('Audio generated:', message)}
  onAudioSaved={(message) => console.log('Audio saved:', message)}
/>
```

### 3. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–π

```tsx
import { AudioMessageRenderer } from '../components/AudioMessageRenderer';

<AudioMessageRenderer message={audioMessage} />
```

## üîß API Endpoints

### Backend API

**POST `/api/audio/synthesize`** - –°–∏–Ω—Ç–µ–∑ –∞—É–¥–∏–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞
```json
{
  "text": "–¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏",
  "chat_id": "chat-123",
  "voice_id": "yandex-oksana",
  "language": "ru",
  "speed": 1.0,
  "provider": "yandex"
}
```

**GET `/api/audio/{chat_id}/{filename}`** - –ü–æ–ª—É—á–µ–Ω–∏–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞

**POST `/api/audio/upload`** - –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞

**DELETE `/api/audio/{chat_id}/{filename}`** - –£–¥–∞–ª–µ–Ω–∏–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞

**GET `/api/audio/{chat_id}/list`** - –°–ø–∏—Å–æ–∫ –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤ —á–∞—Ç–∞

## üìä –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

### AudioMessage
```typescript
interface AudioMessage {
  id: string;
  role: 'assistant';
  content_type: 'audio.v1';
  content: AudioContent;
  timestamp: number;
}
```

### AudioContent
```typescript
interface AudioContent {
  text: string;           // –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
  audioUrl: string;       // URL –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞
  duration?: number;      // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  provider: string;       // yandex, elevenlabs, etc.
  voiceId?: string;       // ID –≥–æ–ª–æ—Å–∞
  format?: string;        // mp3, ogg, wav
  size?: number;          // –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö
}
```

## üé® UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### AudioMessageRenderer
- **–ü–ª–µ–µ—Ä** —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è/–ø–∞—É–∑—ã
- **–ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä** —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–º–æ—Ç–∫–∏
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** –æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ, –≥–æ–ª–æ—Å–µ, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è** –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞
- **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏** —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –æ–±—â–µ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### AudioTTSButton
- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ** –∏–∑ —Ç–µ–∫—Å—Ç–∞
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** –≤ —á–∞—Ç
- **–°–æ—Å—Ç–æ—è–Ω–∏—è** –∑–∞–≥—Ä—É–∑–∫–∏, —É—Å–ø–µ—Ö–∞, –æ—à–∏–±–∫–∏
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** –≥–æ–ª–æ—Å–∞, —è–∑—ã–∫–∞, —Å–∫–æ—Ä–æ—Å—Ç–∏

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û–∑–≤—É—á–∏—Ç—å"
2. **Frontend** –≤—ã–∑—ã–≤–∞–µ—Ç `generateAudioMessage()`
3. **TTSService** —Å–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ TTS API
4. **AudioBuffer** –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ Blob –∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è URL
5. **AudioMessage** —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
6. **Backend API** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞—É–¥–∏–æ —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
7. **Chat** –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤–æ–µ –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
8. **UI** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–ª–µ–µ—Ä –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

## üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### Frontend
```typescript
// –í config/overrides.toml
[voice.tts]
provider = "yandex"
yandex_voice = "oksana"
yandex_use_v3_rest = true
```

### Backend
```python
# –í brain_service/api/audio.py
AUDIO_STORAGE_DIR = Path("audio_storage")
```

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤** - –∞—É–¥–∏–æ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- **–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞** - –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Å–ª—É—à–∞—Ç—å –ª—é–±–æ–µ –∞—É–¥–∏–æ
- **–°–∫–∞—á–∏–≤–∞–Ω–∏–µ** - –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞—É–¥–∏–æ –ª–æ–∫–∞–ª—å–Ω–æ
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö TTS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –∞—É–¥–∏–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- [ ] **–°–∂–∞—Ç–∏–µ** –∞—É–¥–∏–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
- [ ] **–ü–æ—Ç–æ–∫–æ–≤–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ** –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- [ ] **–ü–ª–µ–π–ª–∏—Å—Ç—ã** –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- [ ] **–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è** –∞—É–¥–∏–æ –≤ —Ç–µ–∫—Å—Ç
- [ ] **–ü–æ–∏—Å–∫** –ø–æ –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º


