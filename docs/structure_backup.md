# Структура Brain Service (оригинальная)

## Основные модули и их назначение:

### 1. **main.py** - Главный файл сервиса
- FastAPI приложение
- Основные эндпоинты: `/chat/stream`, `/chats`, `/health`
- Управление сессиями через Redis
- Интеграция с различными сервисами

### 2. **llm_config.py** - Конфигурация LLM
- Функция `get_llm_for_task()` для выбора модели по задаче
- Поддержка различных провайдеров (OpenAI, OpenRouter, Ollama)
- Управление параметрами моделей (temperature, top_p, etc.)

### 3. **state.py** - Управление состоянием
- Класс `Session` для управления сессиями чатов
- Класс `Message` для сообщений
- Глобальное состояние `state` с сессиями и персонажами

### 4. **sefaria_client.py** - Интеграция с Sefaria
- Функции для получения текстов из Sefaria API
- `sefaria_get_text_v3_async()` - получение текстов
- `sefaria_get_related_links_async()` - получение связанных ссылок

### 5. **research_planner.py** - Планировщик исследований
- Функция `parse_initial_request()` для разбора запросов
- Создание плана исследования на основе запроса пользователя

### 6. **deep_research/** - Модуль глубокого исследования
- **orchestrator.py** - основной оркестратор исследований
- **context.py** - управление контекстом исследований
- **dialogue_system.py** - система диалогов для критики
- **cycle_detector.py** - детектор циклов в исследованиях
- **progress_analyzer.py** - анализатор прогресса исследований

### 7. **memory_client.py** - Клиент для memory сервиса
- Функция `store_chunks_in_memory()` для сохранения чанков
- Интеграция с внешним memory сервисом

### 8. **tts_client.py** - Text-to-Speech
- Функция `get_tts_client()` для получения TTS клиента
- Интеграция с различными TTS сервисами

### 9. **document_export.py** - Экспорт документов
- Функция `export_plain_document()` для экспорта результатов
- Автоматический экспорт при включенной опции

### 10. **metrics.py** - Метрики и мониторинг
- Сбор метрик производительности
- Интеграция с Prometheus

### 11. **logging_utils.py** - Утилиты логирования
- Стандартизированное логирование
- Различные уровни логирования для разных сервисов

## Ключевые особенности оригинальной структуры:

1. **Модульная архитектура** - каждый компонент в отдельном файле
2. **Асинхронность** - использование async/await для всех операций
3. **Redis интеграция** - для хранения сессий и кеширования
4. **FastAPI** - современный веб-фреймворк с автоматической документацией
5. **Типизация** - использование Pydantic моделей для валидации данных
6. **Конфигурируемость** - через переменные окружения
7. **Отказоустойчивость** - обработка ошибок и fallback'и

## Основные эндпоинты:
- `POST /chat/stream` - стриминг ответов от AI
- `GET /chats` - получение списка чатов
- `GET /chats/{session_id}` - получение истории чата
- `GET /health` - проверка здоровья сервиса

## Переменные окружения:
- `REDIS_URL` - URL Redis сервера
- `MEMORY_SERVICE_URL` - URL сервиса памяти
- `TTS_SERVICE_URL` - URL TTS сервиса
- `OPENAI_TEMPERATURE` - температура для OpenAI моделей
- И другие параметры моделей и сервисов

Эта структура обеспечивала хорошую масштабируемость, тестируемость и поддерживаемость кода.