# План работ: двуязычные тексты Sefaria **без поломки** Bookshelf
Дата: 2025-09-28 20:15


## Цель
Внедрить получение текста **на иврите (HE)** и **английском (EN)** через Sefaria API v3, не ломая текущий интерфейс **Bookshelf** и существующие фичи. Выполнить поэтапно, с обратной совместимостью и чёткими критериями приёмки.

---

## Результат (Definition of Done)
1. Новый backend-эндпоинт возвращает по `tref` структуру:
   ```json
   {
     "ok": true,
     "ref": "Berakhot 14b:2",
     "he": "…",
     "en": "…",
     "meta": {
       "heRef": "…",
       "chosen_versions": { "he": "…", "en": "…" },
       "warnings": []
     }
   }
   ```
2. Текущие эндпоинты (используемые Bookshelf) **не меняют контракта** и не ломают UI.
3. /api/links отдаёт элементы в прежнем формате (или строго совместимом): **каждый item имеет `ref`** (строка) и/или `metadata.ref`.
4. Ручные тесты (чек-лист ниже) и базовые unit-тесты зелёные.
5. Фича включается флагом, Bookshelf можно переключить на двуязычный режим отдельным PR без риска.

---

## Негативные риски / анти-цели
- Не меняем существующие ключи в ответах, которые ест Bookshelf (например, `items`, `preview` как строка) — до отдельного согласованного PR.
- Не внедряем «массовый рефакторинг» UI; только адаптеры/флаги.
- Не полагаемся на формат /api/links одного вида — поддерживаем list **и** dict с ключом `links`.

---

## Архитектура решения (вкратце)
- **Backend**: новая функция `get_bilingual_text()` на базе Sefaria v3 `texts/{tref}` с параметром `version` (две штуки): `english` и `hebrew`. Парсим `versions[]` → складываем в `he/en`. Фоллбек: два одиночных запроса (EN, HE). Таймауты/ретраи/URL-encoding.
- **Ссылки**: `/api/links/{tref}` → парсим ответ корректно (и list, и dict), нормализуем каждый item → гарантируем `item.ref` (или `metadata.ref`), дедуп и мягкая фильтрация по категориям.
- **Совместимость**: для Bookshelf никаких ломающих изменений: возвращаем прежние ключи (`items`, `preview` как строка). Для нового двуязычного рендера будет отдельный флаг/эндпоинт.

---

## Пошаговый план (итерации)

### Итерация 0 — Подготовка
1. Создать ветку `feature/sefaria-bilingual` от текущего стабильного коммита.
2. Ввести флаг окружения `ASTRA_SEFARIA_BILINGUAL=0` (по умолчанию выключено).
3. Протокол логов: `SEFARIA_TEXTS`, `SEFARIA_LINKS`, уровень `INFO/DEBUG` для диагностики.

### Итерация 1 — Backend: двуязычный текст **без влияния** на существующие вызовы
1. Добавить модуль `bilingual_text.py` (или функцию в существующий клиент) с API:
   ```python
   async def get_bilingual_text(tref: str,
                                he_pref: str | None = None,
                                en_pref: str | None = None,
                                return_format: str = "text_only",
                                fill_missing: int = 0,
                                join_section_with: str = "\n") -> dict: ...
   ```
2. Реализация:
   - Нормализация `tref` (NFKC, `quote()`).
   - **Один комбинированный запрос**: `version=english&version=hebrew`.
   - Если `versions` отсутствуют или один из языков пуст — **фоллбек двумя запросами** (EN, HE).
   - Извлечение языка по `actualLanguage.lower()` с запасным `language`.
   - Склейка секции: список → строка через `join_section_with`.
   - Заполнение `meta.chosen_versions`, `ref`, `heRef`, `warnings`.
   - `ok=True`, если найден хотя бы один язык.
3. Эндпоинт: `GET /api/texts/bilingual?tref=...` → возвращает **ровно** целевой контракт (см. DoD).  
4. Тесты:
   - `Berakhot 14b:2` (оба языка).
   - `Genesis 1` (секция, склейка).
   - Редкий текст (отсутствие EN/HE).
   - Сломанный `tref` (нормализация/quote).

### Итерация 2 — Backend: ссылки и совместимость
1. `/api/links/{tref}`: корректный парсер ответа:
   - Если `list` → это сами ссылки.
   - Если `dict` → берём `links`.
2. Нормализатор элементов (всегда!):
   - `ref = item.ref or item.anchorRef or item.sourceRef or ""`
   - `metadata.ref = ref` (если пусто).
   - **Без изменения других полей**, которыми пользуется Bookshelf.
3. Дедуп и фильтр по категориям с логом счётчиков до/после.
4. Возвращаем старый контракт для UI:
   ```json
   { "ok": true, "items": [ ... ] }
   ```
5. Тесты: 3–4 референса (Talmud, SA, Midrash), проверка наличия `items[0].ref`.

### Итерация 3 — UI: подготовка адаптеров (без включения в Bookshelf)
1. В клиенте API добавить обёртку для нового эндпоинта `/api/texts/bilingual` (типизация с `{ok,ref,he,en,meta}`).
2. Добавить утилиту:
   ```ts
   export function coalescePreviewFromBilingual(item: any): string | undefined
   ```
   Возвращает строку-превью из `{he,en}` или старого `preview`/`text` — пригодится для постепенной миграции UI.
3. Фичефлаг `useBilingualTexts` (по умолчанию `false`).  
   Включение флага **не должно затронуть Bookshelf** на этой итерации.

### Итерация 4 — UI: безопасная миграция Bookshelf (отдельный PR)
1. `groupByRef(items)`:
   - Сначала пробовать `item.metadata.(commentator,tractate,page,section)`.
   - Иначе парсить `item.ref` регуляркой.
   - Если всё пусто — отправить в `orphans` (но показывать).
2. Превью (поисковые индексы, подсказки): в одном месте заменить доступ к полю на `coalescePreviewFromBilingual(item)`.
3. Никаких других изменений поведения (вёрстка, маршруты) — отдельные PR при необходимости.

> Если есть риск, **не включать** двуязычие в Bookshelf, пока не пройдём чек-лист в песочнице. Флаг на проде остаётся `false`.

### Итерация 5 — Приёмка и включение фичи
1. В песочнице включить `ASTRA_SEFARIA_BILINGUAL=1` и `useBilingualTexts=true`.
2. Пройти чек-лист (см. ниже).
3. Если всё ок — мерж ветки и постепенное включение фичи (по флагу).

---

## Контракты (для избежания регрессий)

### `/api/texts/bilingual`
- **Вход**: `tref` (строка), опц. `he_pref`, `en_pref`, `return_format`, `fill_missing`.
- **Выход** — строго:
  ```json
  {
    "ok": true,
    "ref": "…",
    "he": "…|null",
    "en": "…|null",
    "meta": {
      "heRef": "…|null",
      "chosen_versions": { "he": "…|null", "en": "…|null" },
      "warnings": ["…"]
    }
  }
  ```

### `/api/links/{tref}` → без изменений для Bookshelf
- **Выход**:
  ```json
  {
    "ok": true,
    "items": [ {
      "ref": "…",                // гарантированно присутствует (или metadata.ref)
      "metadata": { "ref": "…" }
    }]
  }
  ```

---

## Чек-лист ручной проверки

### Backend
- [ ] `GET /api/texts/bilingual?tref=Berakhot%2014b%3A2` → `he` и `en` не пустые, `ok=true`.
- [ ] `GET /api/texts/bilingual?tref=Genesis%201` → `he`/`en` строки, секции склеены `\n`.
- [ ] Редкий текст → один из языков `null`, но `ok=true`.
- [ ] `GET /api/links/Shabbat%2012a%3A5` → `ok=true`, `items.length>0`, `items[0].ref` есть.
- [ ] Логи: `raw=… final=…` и распределение категорий.

### UI (с флагом выключено)
- [ ] Bookshelf отображает прежние источники; счётчики и группы корректны.
- [ ] Поиск по превью (EN/HE) работает как раньше.

### UI (песочница, флаг включён)
- [ ] В местах, где подключены двуязычные тексты, рендер корректен; Bookshelf не сломан.
- [ ] `coalescePreviewFromBilingual` не вызывает ошибок (`toLowerCase` и т. п.).

---

## Откат (Rollback plan)
- Сразу после мёржа: фича **за фичефлагом**. При проблемах достаточно выключить флаг `ASTRA_SEFARIA_BILINGUAL` и/или `useBilingualTexts` — UI вернётся к прежнему поведению, без отката кода.
- Точка возврата: тэг `pre-bilingual-bookshelf` (создать сейчас).

---

## Риски и способы минимизации
- **Разный формат `links` у Sefaria** → парсер на обе формы, нормализатор `ref`.
- **Потеря превью** → `coalescePreviewFromBilingual` на бэкенде (опционально) или в UI-адаптере.
- **RTL/LTR** → определять направление по конкретной строке превью.
- **Лакуны перевода** → параметр `fill_missing=0` по умолчанию; включать осознанно с `warnings`.

---

## Точки контроля качества (QC)
- Unit-тесты на разбор `versions[]` (EN/HE), секции, фоллбеки.
- Снапшоты JSON по ключевым эндпоинтам.
- Лимиты таймаутов и ретраев (5–10 c суммарно).

---

## Нотации и ссылки (внутренние)
- Sefaria v3 `texts/{tref}` — тексты лежат в `versions[]`, язык в `actualLanguage`/`language`.
- `version` принимает несколько значений: `english` и `hebrew` одновременно; форма `language|versionTitle` — для фиксированных изданий.
- `return_format=text_only` — без HTML/сносок.

---

## Итог
Внедряем двуязычие аккуратно: новый эндпоинт и адаптеры, **без изменения** существующих контрактов Bookshelf. Затем, отдельным PR и под фичефлагом, подключаем новый рендер. Это даёт быстрый прогресс без риска уронить текущую систему.
