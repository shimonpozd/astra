–¢–ó ¬´–£—á–µ–±–Ω—ã–π —Å—Ç–æ–ª¬ª v1 (backend-first)
0) –¶–µ–ª–∏

–î–∞—Ç—å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ —Ç–µ–∫—Å—Ç–∞–º –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º –±–µ–∑ —É—á–∞—Å—Ç–∏—è LLM.

–ù–µ —Ç–µ—Ä—è—Ç—å ¬´—Ç–æ—á–∫—É –≤—Ö–æ–¥–∞¬ª: –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –º–µ—Å—Ç—É –∏ –ø—É—Ç–∏ —É–≥–ª—É–±–ª–µ–Ω–∏—è.

–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞—Ç—å –æ–∫–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: —Ñ–æ–∫—É—Å + 5 –≤–ø–µ—Ä—ë–¥ + 5 –Ω–∞–∑–∞–¥, —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç ¬´–±–æ–ª—å—à–∏—Ö –∫—É—Å–∫–æ–≤¬ª.

–û—Å—Ç–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç (–æ–¥–Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—è Qdrant –Ω–∞ —á–∞—Ç), –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∂–∏–º ¬´–£—á–µ–±–Ω—ã–π —Å—Ç–æ–ª¬ª.

–ò–∑ —Ä–µ–∂–∏–º–∞ ¬´–£—á–µ–±–Ω—ã–π —Å—Ç–æ–ª¬ª —É–º–µ—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å deep research –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ñ–æ–∫—É—Å—É.

1) –ú–æ–¥–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ Redis (–æ–¥–Ω–∞ —Å–µ—Å—Å–∏—è = –æ–¥–∏–Ω ¬´—Å—Ç–æ–ª¬ª)

–•—Ä–∞–Ω–∏–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Ç–µ–∫—É—â–µ–µ (–∫–∞–∫ –±—Ä–∞—É–∑–µ—Ä: back/forward), —á—Ç–æ–±—ã —Ç–µ–±–µ –Ω–µ –±—ã–ª–æ ¬´—Å–ª–æ–∂–Ω–æ¬ª (–ø.7 üòâ).

study:sess:{sid}:history ‚Äî LIST JSON-—Å–Ω–∏–º–∫–æ–≤ (—Å–º. –Ω–∏–∂–µ), –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è.

study:sess:{sid}:cursor ‚Äî INTEGER (–∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–Ω–∏–º–∫–∞ –≤ history).

study:sess:{sid}:top ‚Äî STRING JSON (–∫–µ—à —Ç–µ–∫—É—â–µ–≥–æ —Å–Ω–∏–º–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ GET).

TTL –Ω–∞ –∫–ª—é—á–∏: 30 –¥–Ω–µ–π.

–°–Ω–∏–º–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è (StudySnapshot)
{
  "focus": {
    "ref": "Shabbat 21a.2",
    "title": "◊©◊ë◊™ ◊õ\"◊ê ◊ê",
    "text_full": "‚Ä¶ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Ñ–æ–∫—É—Å–∞ ‚Ä¶",
    "collection": "Talmud"     // Bible|Mishnah|Talmud|Halakhah|‚Ä¶ (–¥–µ—Ç–µ–∫—Ç–∏–º)
  },
  "window": {
    "prev": [ { "ref":"Shabbat 21a.1", "preview":"‚Ä¶<=600 —Å–∏–º–≤–æ–ª–æ–≤‚Ä¶" }, ‚Ä¶ –º–∞–∫—Å–∏–º—É–º 5 ],
    "next": [ { "ref":"Shabbat 21a.3", "preview":"‚Ä¶" }, ‚Ä¶ –º–∞–∫—Å–∏–º—É–º 5 ]
  },
  "bookshelf": {
    "counts": { "Commentary": 12, "Talmud": 3, "Midrash": 1, ‚Ä¶ },
    "items": [
      {
        "ref": "Rashi on Shabbat 21a:2:1",
        "title": "◊®◊©\"◊ô ◊©◊ë◊™ ◊õ\"◊ê ◊ê",
        "category": "Commentary",
        "commentator": "Rashi",
        "preview": "‚Ä¶<=400‚Äì600‚Ä¶"
      }
      // –¥–æ limit (–¥–µ—Ñ–æ–ª—Ç 40), —Å–º. ¬ß3.2
    ]
  },
  "chat_local": [ {"role":"user","content":"‚Ä¶"}, {"role":"assistant","content":"‚Ä¶"} ],
  "ts": 1732451000
}


–í–∞–∂–Ω–æ: chat_local ‚Äî —á–∞—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ —ç—Ç–æ—Ç —Ñ–æ–∫—É—Å. –û–±—â–∏–π —á–∞—Ç –∏ Qdrant –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ —Å–µ–π—á–∞—Å: –æ–¥–Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–∞ —á–∞—Ç, —Ç—ã —Ç—É–¥–∞ —Å–∫–ª–∞–¥—ã–≤–∞–µ—à—å –≤—Å—ë (—Ç–µ–∫—Å—Ç, –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ —Ç.–¥.).

2) –ê–ª–≥–æ—Ä–∏—Ç–º—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ)
2.1 –û–∫–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ¬´—Ñ–æ–∫—É—Å + 5 –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä—ë–¥¬ª

–ü–∞—Ä–∞–º–µ—Ç—Ä WINDOW_SIZE=5 (–¥–µ–ª–∞–µ–º –∫–æ–Ω—Ñ–∏–≥).

–î–ª—è Talmud:

–†–µ—Ñ –≤–∏–¥–∞ Masechet Daf(amud).segment ‚Üí –¥–≤–∏–≥–∞–µ–º segment ¬±1.

–ï—Å–ª–∏ segment-–∞ –Ω–µ—Ç (–Ω–∞–ø—Ä. ¬´Shabbat 23a¬ª) ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å–ø–∏—Å–æ–∫ —Å–µ–≥–º–µ–Ω—Ç–æ–≤) —á–µ—Ä–µ–∑ v3/v2; –µ—Å–ª–∏ –Ω–µ—Ç, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å–µ–¥–µ–π.

–ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Å–µ–≥–º–µ–Ω—Ç–æ–≤:

‚Ä¶a.lastSegment + 1 ‚Üí ‚Ä¶b.1

‚Ä¶b.lastSegment + 1 ‚Üí next Daf a.1

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –Ω–∞–∑–∞–¥.

–î–ª—è Bible (Tanakh): Book C:V

V+1 –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥–ª–∞–≤—ã; –µ—Å–ª–∏ V –±–æ–ª—å—à–µ, ‚Üí C+1:1 (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–ª–µ–¥—É—é—â–∞—è –≥–ª–∞–≤–∞).

–ù–∞–∑–∞–¥ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ.

–î–ª—è Mishnah/Halakhah: –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ: —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π :N/.N; –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —Å–æ—Å–µ–¥–µ–π –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º.

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å–µ–¥–µ–π: –∫–∞–∂–¥—ã–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ref –≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–æ—Ä–æ—Ç–∫–∏–º –∑–∞–ø—Ä–æ—Å–æ–º —Ç–µ–∫—Å—Ç–∞. –ü—É—Å—Ç–æ ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.

2.2 –ó–∞—â–∏—Ç–∞ –æ—Ç ¬´–±–æ–ª—å—à–∏—Ö –∫—É—Å–∫–æ–≤¬ª

text_full —Ç–æ–ª—å–∫–æ —É —Ñ–æ–∫—É—Å–∞.

preview —É —Å–æ—Å–µ–¥–µ–π/–∫–Ω–∏–∂–Ω–æ–π –ø–æ–ª–∫–∏ –æ–±—Ä–µ–∑–∞–µ–º –¥–æ 400‚Äì600 —Å–∏–º–≤–æ–ª–æ–≤ (–ø–æ –≥—Ä–∞–Ω–∏—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –ª–µ–≥–∫–æ).

–ï—Å–ª–∏ –∫—É—Å–æ–∫ –æ–≥—Ä–æ–º–Ω—ã–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª–∏–Ω–Ω—ã–π –º–∏–¥—Ä–∞—à) ‚Äî –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ ~2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.

3) –ö–Ω–∏–∂–Ω–∞—è –ø–æ–ª–∫–∞ (bookshelf)
3.1 –ü–æ–ª—É—á–µ–Ω–∏–µ

–°–Ω–∞—á–∞–ª–∞ /api/related/<ref>, –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî /api/links/<ref>, –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî ¬´–ø–æ–¥–Ω—è—Ç—å —É—Ä–æ–≤–µ–Ω—å¬ª (–æ—Ç—Ä–µ–∑–∞—Ç—å :N/.N).

–§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —Ç–∏–ø—ã, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫ –∫–∞–Ω–æ–Ω—É (—Ç–≤–æ—è –º–∞—Ç—Ä–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π).

–ö–≤–æ—Ç—ã: —Ç—ã —Å–∫–∞–∑–∞–ª ¬´–Ω–µ –Ω–∞–¥–æ¬ª ‚Äî –æ–∫, –Ω–µ —Ä–µ–∂–µ–º, –Ω–æ:

—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (—Å–º. 3.2),

–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–¥–∞—ë–º –ø–µ—Ä–≤—ã–µ 40 (–ø–∞—Ä–∞–º–µ—Ç—Ä limit), —Ñ—Ä–æ–Ω—Ç –º–æ–∂–µ—Ç –¥–æ–≥—Ä—É–∂–∞—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π ?offset=.

3.2 –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (–±–µ–∑ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤, –±—ã—Å—Ç—Ä–æ)

–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ Study Flow (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç collection —Ñ–æ–∫—É—Å–∞).

–í–µ—Å ¬´–∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç–∏¬ª –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä–æ–≤ (Rashi, Ramban, Tosafot, Shach, Taz‚Ä¶).

–ò—Ç–æ–≥: score = w_flow + w_author, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ score —É–±—ã–≤.

3.3 –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞

bookshelf.counts ‚Äî –æ–±—ä–µ–∫—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞: —Ä–∏—Å–æ–≤–∞—Ç—å –≤–∫–ª–∞–¥–∫–∏-—Ñ–∏–ª—å—Ç—Ä—ã).

bookshelf.items ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞: title, ref, category, commentator, preview.

–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –≤ –∑–∞–ø—Ä–æ—Å–µ: ?categories=Commentary,Midrash (–±—ç–∫–µ–Ω–¥ —Å—Ä–∞–∑—É –æ—Ç–¥–∞—ë—Ç –Ω—É–∂–Ω—ã–π —Å—Ä–µ–∑).

–†–∞—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º GET /bookshelf/item?ref=... (–ø–æ –∫–ª–∏–∫—É/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—é –≤ —á–∞—Ç).

4) –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã FastAPI
4.1 –í—ã–±–æ—Ä –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–Ω–æ–≤–æ–µ, –±–µ–∑ LLM)

POST /study/resolve

{ "query": "Shabbat 21a.2" }


–ï—Å–ª–∏ —É–∂–µ –≤–∞–ª–∏–¥–Ω—ã–π tref ‚Üí –æ—Ç–¥–∞—ë–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π ref –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (collection, title).

–ï—Å–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π ‚Üí –ø–æ–∏—Å–∫: Sefaria Index//search (en/he), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã.

(–û–ø—Ü.) LLM-fallback –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ, –Ω–æ v1 –¥–µ–ª–∞–µ–º –±–µ–∑ LLM.

–û—Ç–≤–µ—Ç:

{ "ok": true, "ref": "Shabbat 21a.2", "collection":"Talmud", "title":"‚Ä¶" }


–∏–ª–∏

{ "ok": false, "candidates": [ { "ref":"Shabbat 21a", "title":"‚Ä¶" }, ‚Ä¶ ] }

4.2 –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ–∫—É—Å (+ –æ–∫–Ω–æ –∏ –ø–æ–ª–∫—É)

POST /study/set_focus

{ "session_id":"...", "ref":"Shabbat 21a.2", "window_size":5 }


–ü–æ–ª—É—á–∞–µ–º text_full, prev/next (–¥–æ 5 –∏ 5), bookshelf (counts+items).

–°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Å–Ω–∏–º–æ–∫.

–ï—Å–ª–∏ cursor –Ω–µ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–Ω–∏–º–∫–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ–¥–∏–ª ¬´–Ω–∞–∑–∞–¥¬ª), ‚Äî –æ–±—Ä–µ–∑–∞–µ–º ¬´–≤–ø–µ—Ä—ë–¥¬ª (–∫–∞–∫ –±—Ä–∞—É–∑–µ—Ä: –Ω–æ–≤–∞—è –≤–µ—Ç–∫–∞).

–ü—É—à–∏–º —Å–Ω–∏–º–æ–∫ –≤ –∏—Å—Ç–æ—Ä–∏—é, –æ–±–Ω–æ–≤–ª—è–µ–º cursor, –ø–∏—à–µ–º top.

–û—Ç–≤–µ—Ç: {"ok":true, "state":<snapshot>}

4.3 –ù–∞–∑–∞–¥/–≤–ø–µ—Ä—ë–¥ (–±–µ–∑ LLM)

POST /study/back ‚Üí cursor -= 1, top = history[cursor]

POST /study/forward ‚Üí cursor += 1, top = history[cursor]

–ì—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º (–µ—Å–ª–∏ –Ω–µ–ª—å–∑—è ‚Äî 400).

4.4 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ –∏–Ω–¥–µ–∫—Å—É (—Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏)

POST /study/restore

{ "session_id":"...", "index": 3 }


cursor = index, –Ω–µ –æ–±—Ä–µ–∑–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é (—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ ¬´–≤–ø–µ—Ä—ë–¥¬ª).

–ï—Å–ª–∏ –ø–æ—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç set_focus ‚Äî –æ–±—Ä–µ–∑–∞–µ–º ¬´–≤–ø–µ—Ä—ë–¥¬ª (–Ω–æ–≤–∞—è –≤–µ—Ç–∫–∞).

4.5 –õ–æ–∫–∞–ª—å–Ω—ã–π —á–∞—Ç –ø–æ —Ñ–æ–∫—É—Å—É

POST /study/chat

{ "session_id":"...", "text":"‚Ä¶" }


–ë–µ—Ä—ë–º top.focus.text_full, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ 1‚Äì2 bookshelf.items (–ø–æ –ª—É—á—à–µ–º—É score) –∫–∞–∫ –ø–æ–¥—Å–∫–∞–∑–∫—É.

System-prompt: ¬´–¢—ã ‚Äî —Ö–µ–≤—Ä—É—Ç–∞. –û–±—Å—É–∂–¥–∞–µ–º —Ç–æ–ª—å–∫–æ focus_text. –°–Ω–∞—á–∞–ª–∞ –ø—à–∞—Ç, –∑–∞—Ç–µ–º 1‚Äì2 –∑–∞–º–µ—á–∞–Ω–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ ref. –ù–∞–≤–∏–≥–∞—Ü–∏–µ–π –Ω–µ —É–ø—Ä–∞–≤–ª—è–π.¬ª

–í—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏ —Å reasoning –ø–æ –∫–æ–Ω—Ñ–∏–≥—É (OpenRouter reasoning={effort,exclude}).

–û—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª—è–µ–º –≤ chat_local —Ç–µ–∫—É—â–µ–≥–æ —Å–Ω–∏–º–∫–∞; –ø–∏—à–µ–º –≤ Redis top –∏ history[cursor].

4.6 –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª–∫–∏

GET /study/bookshelf/item?session_id=...&ref=...

–í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ (–Ω–µ preview) + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (title, category, commentator).

–§—Ä–æ–Ω—Ç –ª–∏–±–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´–ø–æ–¥–ª–æ–∂–∫—É¬ª, –ª–∏–±–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –≤ –æ–±—â–∏–π —á–∞—Ç (–∫–∞–∫ —Å–µ–π—á–∞—Å).

4.7 –ì—Ä–∞—Ñ-—ç–∫—Å–ø–æ—Ä—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —Ç–≤–æ–µ–π –∏–¥–µ–∏ canvas)

GET /study/graph?session_id=...

–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∂–∞—Ç—ã–π –≥—Ä–∞—Ñ –∏–∑ history: –Ω–æ–¥—ã=–≤—Å–µ focus.ref + –≤—Å–µ bookshelf.items.ref, —Ä–µ–±—Ä–∞=¬´–∏–∑ —Ñ–æ–∫—É—Å–∞ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ¬ª, –ø–ª—é—Å –ª–∏–Ω–µ–π–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ —Ñ–æ–∫—É—Å–æ–≤ (–∫–∞–∫ —Å–ª–æ–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏).

–§—Ä–æ–Ω—Ç –º–æ–∂–µ—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å ¬´–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ª–µ–Ω—Ç—É¬ª Psachim 1a ‚Üí 1b ‚Ä¶, –æ—Ç –∫–∞–∂–¥–æ–π ‚Äî –≤–µ—Ç–≤–∏ –∫ Commentary/Midrash/‚Ä¶
(–≠—Ç–æ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤ v1, –Ω–æ –±—ç–∫–µ–Ω–¥-–¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤–∏–º.)

5) –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å deep research

–ö–Ω–æ–ø–∫–∞ ¬´–°–¥–µ–ª–∞–π –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞¬ª –≤—ã–∑—ã–≤–∞–µ—Ç:
POST /study/deepresearch

{ "session_id":"..." }


–ë—ç–∫–µ–Ω–¥ –±–µ—Ä—ë—Ç top.focus.ref, –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–≤–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π flow deep_research (—Å –Ω–∞—à–µ–π –∏–µ—Ä–∞—Ä—Ö–∏–µ–π/Source-First —É–∂–µ –≤ –∫–æ–¥–µ).

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (–∏–ª–∏ id –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ —Ä–µ—à–∏—à—å –¥–µ–ª–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ). –í v1 ‚Äî –º–æ–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —Ç—ã –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.

6) Sefaria-–∫–ª–∏–µ–Ω—Ç: –Ω—É–∂–Ω—ã–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è tref (–∫–∞–∫ —É —Ç–µ–±—è —É–∂–µ –±—ã–ª–æ): NFC, –∞–ø–æ—Å—Ç—Ä–æ—Ñ—ã ‚Üí ", –∞–ª–∏–∞—Å—ã (Arukh‚ÜíAruch, De‚Äôah‚ÜíDeah), —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤.

–¢–µ–∫—Å—Ç—ã: v3 /v3/texts/{ref}?lang=...&return_format=text_only, –µ—Å–ª–∏ 404 ‚Üí v2 /api/texts/{ref}.

Related/Links: related ‚Üí links ‚Üí parent(:N/.N); —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º; –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è category –∫ –Ω–∞—à–µ–º—É –∫–∞–Ω–æ–Ω—É.

–°–æ—Å–µ–¥–∏:

–î–ª—è Talmud ‚Äî –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ) –ª–∏–±–æ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π ref‚Äô–æ–≤ —Å –∑–∞–ø—Ä–æ—Å–æ–º —Ç–µ–∫—Å—Ç–∞.

–î–ª—è Bible ‚Äî –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—Ç–∏—Ö/–≥–ª–∞–≤–∞.

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: –≤ –º–µ—Ç–æ–¥–∞—Ö –¥–ª—è —Å–æ—Å–µ–¥–µ–π/–ø–æ–ª–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º preview, –ø–æ–ª–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ focus –∏ GET /study/bookshelf/item.

7) –í—ã–±–æ—Ä —Ç–µ–∫—Å—Ç–∞: –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –±–µ–∑ LLM

–ü–æ—Ç–æ–∫ —Ç–∞–∫–æ–π:

–§—Ä–æ–Ω—Ç —à–ª—ë—Ç POST /study/resolve —Å ¬´—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º¬ª –≤–≤–æ–¥–æ–º.

–ï—Å–ª–∏ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π ref ‚Äî —Å—Ä–∞–∑—É POST /study/set_focus.

–ï—Å–ª–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ ‚Äî —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã; —Ñ—Ä–æ–Ω—Ç –ø–æ–∫–∞–∂–µ—Ç —Å–ø–∏—Å–æ–∫; –ø–æ –∫–ª–∏–∫—É ‚Äî set_focus.

(–ï—Å–ª–∏ –ø–æ–∑–∂–µ –∑–∞—Ö–æ—á–µ—à—å ¬´—É–º–Ω—ã–π¬ª –ø–∞—Ä—Å–µ—Ä –Ω–∞ LLM ‚Äî –¥–æ–±–∞–≤–∏–º –∫–∞–∫ –º—è–≥–∫–∏–π fallback, –Ω–æ –≤ v1 —Ä–∞–±–æ—Ç–∞–µ–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ.)

8) –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–±—ä—ë–º—ã

–í—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ: Sefaria –ª–æ–∫–∞–ª—å–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–∞–ª–æ ‚Üí –º–æ–∂–Ω–æ —â–µ–¥—Ä–æ.

–¢–µ–º –Ω–µ –º–µ–Ω–µ–µ:

text_full ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–æ–∫—É—Å–∞;

preview ‚Äî 400‚Äì600 —Å–∏–º–≤–æ–ª–æ–≤;

bookshelf.items ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 40 (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π);

Redis ‚Äî —Ö—Ä–∞–Ω–∏—Ç JSON —Å–Ω–∏–º–∫–æ–≤; –æ–±—ä—ë–º—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º (–ø—Ä–µ–≤—å—é –∫–æ—Ä–æ—Ç–∫–∏–µ).

–î–ª—è —á–∞—Ç–∞/Qdrant ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ–º (–∫–∞–∫ —Å–µ–π—á–∞—Å).

9) –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∫–æ–¥–∏–º –≤ v1

–ù–æ–≤—ã–µ —Ä–æ—É—Ç—ã study_* (—Å–º. ¬ß4): resolve/set_focus/back/forward/restore/chat/bookshelf/item/(graph).

–£—Ç–∏–ª–∏—Ç—ã Sefaria: get_text_with_window(ref, window_size), get_bookshelf_for(ref, limit, categories=‚Ä¶), detect_collection(ref), normalize_tref.

–•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π: –º–∞–ª–µ–Ω—å–∫–∏–π —Å–µ—Ä–≤–∏—Å study_state.py (–æ–±—ë—Ä—Ç–∫–∏ –Ω–∞–¥ Redis: get_top, set_top, push_history, trim_forward, move_cursor, ‚Ä¶).

System-prompt ¬´—Ö–µ–≤—Ä—É—Ç–∞¬ª (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –±–µ–∑ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏).

Reasoning –≤–∫–ª—é—á–∏—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ (OpenRouter reasoning={effort,exclude}) –¥–ª—è –æ—Ç–≤–µ—Ç–∞ —Ö–µ–≤—Ä—É—Ç—ã.

---

## –ü–ª–∞–Ω v2: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

### 1. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "–õ–µ–∫—Å–∏–∫–æ–Ω" (–°–ª–æ–≤–∞—Ä—å)

*   **–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:** –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–ª–æ–≤–∞—Ä–Ω—ã–º —Å—Ç–∞—Ç—å—è–º –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É –Ω–∞ —Å–ª–æ–≤–µ –≤ –ª—é–±–æ–º —Ç–µ–∫—Å—Ç–µ.
*   **–ë—ç–∫–µ–Ω–¥:**
    *   –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç `GET /study/lexicon`.
    *   –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `word: str`.
    *   –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–∫—Å–∏-–∑–∞–ø—Ä–æ—Å –∫ API Sefaria: `https://www.sefaria.org/api/words/{word}`.
    *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã–π JSON –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
*   **–§—Ä–æ–Ω—Ç–µ–Ω–¥:**
    *   –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `dblclick` –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö —Å —Ç–µ–∫—Å—Ç–æ–º.
    *   –ü—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ –∏–∑–≤–ª–µ–∫–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ.
    *   –í—ã–∑—ã–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `GET /study/lexicon?word=...`.
    *   –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–º –æ–∫–Ω–µ (modal) –∏–ª–∏ –Ω–∞ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏.

### 2. "–†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å" –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

*   **–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:** –ù–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –º–µ–∂–¥—É —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –∏ "–∫–Ω–∏–∂–Ω–æ–π –ø–æ–ª–∫–æ–π", –∫—É–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è. –ß–∞—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ —Ç–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–±—Ä–∞–Ω –≤ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏.
*   **–ë—ç–∫–µ–Ω–¥ (–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `StudySnapshot`:
    *   –î–æ–±–∞–≤–∏—Ç—å –≤ `StudySnapshot` –¥–≤–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª—è:
        *   `workbench_items: List[BookshelfItem]` ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ç–∞—â–∏–ª –≤ —Ä–∞–±–æ—á—É—é –æ–±–ª–∞—Å—Ç—å.
        *   `discussion_focus_ref: str` ‚Äî —Å—Å—ã–ª–∫–∞ (`ref`) –Ω–∞ —Ç–æ—Ç —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –æ–±—Å—É–∂–¥–∞–µ—Ç—Å—è –≤ —á–∞—Ç–µ. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–≤–µ–Ω `focus.ref`, –Ω–æ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ `workbench_items`.
    *   –°–æ–∑–¥–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `POST /study/workbench/add`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `ref` –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π `BookshelfItem` –≤ —Å–ø–∏—Å–æ–∫ `workbench_items`.
    *   –°–æ–∑–¥–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `POST /study/chat/set_focus`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `ref` –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ `discussion_focus_ref`.
    *   –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `POST /study/chat`: —Ç–µ–ø–µ—Ä—å –æ–Ω –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `discussion_focus_ref` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –∞ –Ω–µ `focus.ref`.
*   **–§—Ä–æ–Ω—Ç–µ–Ω–¥:**
    *   –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è "–†–∞–±–æ—á–µ–π –æ–±–ª–∞—Å—Ç–∏".
    *   –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É drag-and-drop —Å "–∫–Ω–∏–∂–Ω–æ–π –ø–æ–ª–∫–∏" –≤ "—Ä–∞–±–æ—á—É—é –æ–±–ª–∞—Å—Ç—å", –≤—ã–∑—ã–≤–∞—è `POST /study/workbench/add`.
    *   –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∫–ª–∏–∫–∞ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –≤ "—Ä–∞–±–æ—á–µ–π –æ–±–ª–∞—Å—Ç–∏", –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å `POST /study/chat/set_focus` –∏ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç.
